// Reverse Engineered implant malware string obfuscation
// Shahin.Ramezany@gmail.com

#include <string.h>
#include <malloc.h>

__inline __declspec(naked) deobfuscate(char* str, int len, char* key)
{

	char* 	result;


__asm {


procedure_start:                           
		
		nop
		nop
		nop
		nop
		nop
		nop
		nop
		nop
		nop
		nop
        mov eax,dword ptr ss:[esp+8] ;strlen 
        push ebp
        mov ebp,dword ptr ss:[esp+0x10] ;key
        push esi
        test eax,eax
        mov esi,ebp
        jbe procedure_end
        push edi
        mov edi,eax
        mov eax,dword ptr ss:[esp+0x10];encrypted

stringlength:

        cmp byte ptr ds:[esi],0
        jnz decryption_loop
        mov esi,ebp

decryption_loop:

        mov cl,byte ptr ds:[esi]
        mov dl,byte ptr ds:[eax]
        sub dl,cl
        mov byte ptr ds:[eax],dl
        mov cl,dl
        mov dl,byte ptr ds:[esi]
        xor dl,cl
        inc esi
        mov byte ptr ds:[eax],dl
        inc eax
        dec edi
        jnz stringlength
      
	   pop edi

procedure_end:

        pop esi
        pop ebp
		sub eax, 0x1C
		mov result,eax ; get result
                                       

}

printf("here is : %s \n" ,result); 

__asm
{
	retn
}


}



int main()
{
	//sizes 
	int size;
	int keysize;
	
	//key 
	char *kstr="1002";
	
	char *nkstr=NULL;
	char *newstr=NULL;
	

	//encrypted string 
	char *str="String Here";



	// allocate and size string 
	size = strlen(str);
	newstr = malloc(sizeof(char)*(size+1));
	strcpy(newstr,str);

	keysize = strlen(kstr);
	nkstr = malloc(sizeof(char)*(keysize+1));
	strcpy(nkstr,kstr);
	
	// call deobfuscation routine string 
	deobfuscate(newstr,size,nkstr);
	

	// free allocated memory for strings 
	free(newstr);
	free(nkstr);
	
	return 0 ;
}